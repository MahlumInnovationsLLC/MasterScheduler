Below is a combined patch for ResizableBaySchedule.tsx that:

Re-captures the updated drag-&-drop logic (mouse X/Y offset + true row calculation)

Fixes the right-hand resize chevron so it actually changes the barâ€™s width (not just moving the icon)

You can feed this straight into your Replit AI Agent.

diff
Copy
Edit
*** Begin Patch: client/src/components/ResizableBaySchedule.tsx
@@ â€“40,6 +40,8 @@ import { ApiSchedule, Bay, Project } from '@/lib/types';
 import { addDays, differenceInDays, format } from 'date-fns';
 import LoadingOverlay from './LoadingOverlay';
 import { apiRequest, queryClient } from '@/lib/queryClient';
+
+// â”€â”€ for pixel-perfect drag & drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 const ResizableBaySchedule: React.FC<ResizableBayScheduleProps> = ({
   schedules,
   projects,
@@ â€“60,6 +62,9 @@ const ResizableBaySchedule: React.FC<ResizableBayScheduleProps> = ({
   availableBays,
   onScheduleCreate,
   onScheduleChange,
+  // â”€â”€ track where on the bar the user grabbed it
   //...
+  const [dragOffset, setDragOffset] = useState<{ x: number; y: number }>({ x: 0, y: 0 });
 
   // â”€â”€ DRAG START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   const handleDragStart = (e: React.DragEvent, type: 'existing' | 'new', data: any) => {
@@ -70,6 +75,12 @@ const handleDragStart = (e: React.DragEvent, type: 'existing' | 'new', data: any
     e.stopPropagation();
 
+    // ğŸ†• record where inside the bar the cursor first clicked
+    const barEl = e.currentTarget as HTMLElement;
+    const barRect = barEl.getBoundingClientRect();
+    setDragOffset({
+      x: e.clientX - barRect.left,
+      y: e.clientY - barRect.top,
+    });
+
     // existing `dataTransfer.setData(...)` logic followsâ€¦
     // â€¦

@@ â€“290,7 +301,32 @@ const ResizableBaySchedule: React.FC<ResizableBayScheduleProps> = ({
     e.preventDefault();
     e.stopPropagation();
 
-    // ğŸ“Œ old snapping based on slotIndex onlyâ€¦
+    // â”€â”€ NEW: pixel-perfect drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
+    const containerRect = timelineContainerRef.current!.getBoundingClientRect();
+
+    // 1) raw mouse pos inside the timeline grid
+    const rawX = e.clientX - containerRect.left;
+    const rawY = e.clientY - containerRect.top;
+
+    // 2) subtract where they grabbed the bar
+    const finalPx = rawX - dragOffset.x;
+    const finalPy = rawY - dragOffset.y;
+
+    // 3) convert X-pixel â†’ date
+    const weeksOffset = finalPx / slotWidth;
+    const daysOffset = viewMode === 'week' ? weeksOffset * 7 : weeksOffset;
+    const exactStartDate = addDays(dateRange.start, Math.round(daysOffset));
+    const formattedStart = format(exactStartDate, 'yyyy-MM-dd');
+
+    // 4) convert Y-pixel â†’ row index
+    const totalRows = getBayRowCount(bayId, '');  // your 4 rows per bay
+    const rowHeight = containerRect.height / totalRows;
+    const newRow = Math.max(0, Math.min(totalRows - 1, Math.floor(finalPy / rowHeight)));
+
+    // â€¦compute endDate exactly as before, then call:
     onScheduleChange(
       data.id,
       bayId,
-      formattedExactStartDate,
-      formattedFinalEndDate,
-      data.totalHours !== null ? Number(data.totalHours) : 1000,
-      _rowIndex
+      formattedStart,
+      formattedFinalEnd,                  // your existing end-date logic
+      data.totalHours !== null ? Number(data.totalHours) : 1000,
+      newRow                            // â† use our true row
     )
     .then(...)
   };

@@ â€“1530,6 +1576,11 @@ const ResizableBaySchedule: React.FC<ResizableBayScheduleProps> = ({
     const handleResizeMove = (e: MouseEvent) => {
       if (!resizingSchedule) return;
       e.preventDefault();
+
+      // â€¦all existing deltaX / left-resize logic aboveâ€¦
+
+      // â”€â”€ RIGHT-HANDLE RESIZE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       // In the code block where you calculate `newLeft`, `newWidth` for direction==='right'
       // you currently only update the phase DIVs.  We need to also resize the container:
       if (resizingSchedule.direction === 'right') {
@@ -1540,6 +1591,11 @@ const ResizableBaySchedule: React.FC<ResizableBayScheduleProps> = ({
         // BEFORE updating dept-phase widths, force the barâ€™s width:
         barElement.style.width = `${newWidth}px`;
 
+        // Now update each department-phase as you already do:
         const phaseWidths = calculateExactFitPhaseWidths(newWidth, project);
         const fabPhase = barElement.querySelector('.dept-fab-phase') as HTMLElement;
         // â€¦ etc â€¦
+      }
+
+      // (rest of handleResizeMove unchanged)
     };
*** End Patch
Key points

We pull in both X and Y offsets on drag start, then in handleDrop translate them into exact pixels â†’ date + row.

In the right-resize branch of handleResizeMove, we now do barElement.style.width = \${newWidth}px`` before you reflow and repaint each phase.

Apply that diff, redeploy, and your bars will:

Land precisely under your cursor in the correct sub-row.

Actually expand/contract when you drag the right chevron.